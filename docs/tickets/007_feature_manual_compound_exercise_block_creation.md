# Ticket #007: Feature - Manual Compound Exercise Block Creation

**Status**: Open
**Priority**: Medium
**Type**: feature
**Estimated Points**: 8
**Phase**: 1-CLI

---

## Summary

Add the ability to manually create compound exercise blocks (EMOM/AMRAP/Circuit/Interval) in the CLI workout editor, allowing users to build custom compound exercises with constituent sub-exercises using keyboard shortcuts.

## Background

Currently, the workout generation engine can create compound exercises (EMOM, Circuit, AMRAP, Interval) with sub-exercises, and the editor can replace or modify them. However, users cannot manually create new compound blocks from scratch during editing. This feature fills that gap by allowing users to:

1. Press 'b' to create a compound exercise block
2. Populate it with sub-exercises
3. Specify the block type (EMOM/AMRAP/Circuit/Interval) with keyboard shortcuts
4. Have the system auto-prefix the block name with the appropriate type prefix

This enables advanced users to customize workouts with compound structures matching those generated by the engine.

## Technical Requirements

### Data Structures

Reference WORKOUT_SPEC.md for compound exercise structure:

```typescript
// Compound exercise parent
{
  "name": "[EMOM] EMOM: Pull-ups + Push-ups",
  "category": "emom",
  "week1": {
    "work_time_minutes": 10,
    "work_time_unit": "minutes"
  },
  "sub_exercises": [
    {
      "name": "Pull-ups",
      "week1": { "reps": 8 }
    },
    {
      "name": "Push-ups",
      "week1": { "reps": 15 }
    }
  ]
}
```

### Code Locations

- Files to modify:
  - `src/lib/engine/workout-editor.ts` - Add `createCompoundBlock()` and `setCompoundBlockType()` methods
  - `cli/lib/interactive-workout-editor.ts` - Add keyboard handlers for 'b', 'e', 'a', 'c', 'i'
  - `cli/cli_hotkeys.json` - Document new hotkeys in view_mode.actions
  - `cli/lib/workout-formatter.ts` - Ensure compound blocks without sub-exercises display properly

- Files to create:
  - None (all functionality added to existing files)

- Dependencies:
  - Existing `WorkoutEditor.insertExercise()` method (reference implementation)
  - Existing `WorkoutEditor.insertSubExercise()` method (reference implementation)
  - `workout_generation_rules.json` for smart defaults

### TypeScript Types

All types already exist in `src/lib/engine/types.ts`:

```typescript
export interface ParameterizedExercise {
  name: string;
  category?: "emom" | "amrap" | "circuit" | "interval";
  sub_exercises?: SubExercise[];
  // ... week parameters
}

export interface SubExercise {
  name: string;
  // ... week parameters
}
```

---

## Implementation Plan

### Phase 1: Workout Editor Engine Methods (3 points)

**Goal**: Add core methods to `WorkoutEditor` class for creating and configuring compound blocks

**Steps**:
1. Add `createCompoundBlock()` method to insert empty compound exercise
   - Takes dayKey, insertAfterIndex, defaultCategory (emom/amrap/circuit/interval)
   - Creates exercise with category field and empty sub_exercises array
   - Populates week parameters with smart defaults for compound exercises
   - Generates placeholder name like "[EMOM] (empty block - add sub-exercises)"
   - Adds to undo stack
2. Add `setCompoundBlockType()` method to change block type after creation
   - Takes dayKey, exerciseIndex, newCategory
   - Updates category field
   - Regenerates name prefix based on new category
   - Updates week parameters if needed (e.g., AMRAP vs EMOM time structure)
   - Adds to undo stack
3. Add `updateCompoundBlockName()` helper to regenerate name from sub-exercises
   - Called after sub-exercises are added/removed/renamed
   - Format: "[CATEGORY] CATEGORY: Exercise1 + Exercise2 + Exercise3"
   - Handles empty sub-exercises array: "[CATEGORY] (empty block - add sub-exercises)"

**Files**:
- Modify: `src/lib/engine/workout-editor.ts` (lines 595-680 reference for insertSubExercise pattern)

**Testing**:
- [ ] Unit test: createCompoundBlock() creates valid structure
- [ ] Unit test: setCompoundBlockType() changes category and updates name
- [ ] Unit test: Empty compound block has placeholder name
- [ ] Unit test: Name updates when sub-exercises added
- [ ] Unit test: Undo works for all operations

**Commit Message**:
```
feat(engine): add manual compound block creation to workout editor

- Add createCompoundBlock() method for inserting empty compound exercises
- Add setCompoundBlockType() to change block category after creation
- Add updateCompoundBlockName() to regenerate names from sub-exercises
- Support EMOM, AMRAP, Circuit, Interval types with smart defaults
- Empty blocks show placeholder until sub-exercises added
- All operations fully undoable
```

**Agent Invocations**:
```bash
# Implementation
shredly-code-writer agent with:
"Implement Phase 1 from ticket #007: Add createCompoundBlock(), setCompoundBlockType(),
and updateCompoundBlockName() methods to src/lib/engine/workout-editor.ts. Follow existing
patterns from insertExercise() and insertSubExercise(). Use workout_generation_rules.json
for smart defaults."

# Testing
test-writer agent with:
"Write unit tests for compound block creation from ticket #007 Phase 1. Test: createCompoundBlock()
creates valid structure, setCompoundBlockType() updates category, empty blocks have placeholder names,
names update when sub-exercises added, undo works for all operations."

# Review
test-critic agent with:
"Review tests for ticket #007 Phase 1 compound block creation. Ensure coverage of edge cases:
empty sub-exercises, type changes, undo stack integrity, name generation."

# Code quality
code-quality-assessor agent with:
"Review src/lib/engine/workout-editor.ts changes from ticket #007 Phase 1. Check: follows existing
patterns, proper undo stack usage, TypeScript types correct, error handling."
```

---

### Phase 2: CLI Interactive Editor Integration (3 points)

**Goal**: Add keyboard shortcuts to CLI editor for compound block workflow

**Steps**:
1. Add 'b' hotkey handler in view mode to create compound block
   - Calls `editor.createCompoundBlock()` at current insertion point
   - Defaults to 'emom' category initially
   - Shows status message: "Created EMOM block. Press 'e' to add sub-exercises, or 'a'/'c'/'i' to change type"
   - Navigates to new block in field list
2. Add block type change handlers: 'e' (EMOM), 'a' (AMRAP), 'c' (Circuit), 'i' (Interval)
   - Only active when current field is a compound exercise parent
   - Calls `editor.setCompoundBlockType()` with appropriate category
   - Shows status message: "Changed block type to [CATEGORY]"
   - Re-renders display with updated prefix
3. Modify existing sub-exercise insertion flow
   - When on compound exercise parent insertion point, use `editor.insertSubExercise()`
   - After sub-exercise added, auto-update parent name via `editor.updateCompoundBlockName()`
4. Update help overlay to document new hotkeys

**Files**:
- Modify: `cli/lib/interactive-workout-editor.ts` (lines 144-200 for view mode handlers)
- Modify: `cli/cli_hotkeys.json` (add 'b', 'e', 'a', 'c', 'i' to view_mode.actions)

**Testing**:
- [ ] Manual CLI test: Press 'b' creates empty EMOM block
- [ ] Manual CLI test: Navigate to empty block, press 'e' opens exercise DB browser
- [ ] Manual CLI test: Add sub-exercise, verify parent name updates
- [ ] Manual CLI test: Press 'a' on EMOM block changes it to AMRAP
- [ ] Manual CLI test: Press 'c' changes to Circuit, 'i' changes to Interval
- [ ] Manual CLI test: Undo ('u') reverts block creation
- [ ] Manual CLI test: Help overlay ('?') shows new hotkeys

**Commit Message**:
```
feat(cli): add keyboard shortcuts for manual compound block creation

- Add 'b' hotkey to create empty compound exercise block
- Add 'e', 'a', 'c', 'i' hotkeys to set block type (EMOM/AMRAP/Circuit/Interval)
- Auto-update parent block name when sub-exercises added
- Update help overlay with new hotkey documentation
- Integrate with existing exercise database browser for sub-exercise selection
```

**Agent Invocations**:
```bash
# Implementation
shredly-code-writer agent with:
"Implement Phase 2 from ticket #007: Add keyboard handlers for 'b', 'e', 'a', 'c', 'i'
in cli/lib/interactive-workout-editor.ts. Follow existing patterns from handleViewModeKey().
Update cli/cli_hotkeys.json with new actions."

# Manual testing checklist
# Run: npm run cli
# Generate workout, press 'x' to edit
# Test each hotkey: 'b' -> 'e' (add exercise) -> verify name updates -> 'a' (change to AMRAP)
# Test undo, save, and reload
```

---

### Phase 3: Display and Formatting (2 points)

**Goal**: Ensure compound blocks display correctly in all states (empty, partial, complete)

**Steps**:
1. Update `formatWorkoutInteractive()` to handle empty compound blocks
   - Show placeholder name: "[EMOM] (empty block - add sub-exercises)"
   - Highlight empty blocks differently (e.g., dim/italic)
   - Show "0 sub-exercises" instead of sub-exercise list
2. Add visual indicators for compound block type in single-day view
   - Prefix with bold colored label: "[EMOM]", "[AMRAP]", "[CIRCUIT]", "[INTERVAL]"
   - Use consistent colors: EMOM=blue, AMRAP=green, Circuit=yellow, Interval=magenta
3. Test formatting with compound blocks at various stages
   - Empty block (just created)
   - Partial block (1 sub-exercise)
   - Complete block (2+ sub-exercises)
   - Block with week-to-week progression in sub-exercises

**Files**:
- Modify: `cli/lib/workout-formatter.ts` (formatWorkoutInteractive, formatSingleDayView)

**Testing**:
- [ ] Unit test: formatWorkoutInteractive handles empty compound blocks
- [ ] Unit test: Compound block type prefixes display correctly
- [ ] Manual CLI test: Create empty block, verify placeholder shows
- [ ] Manual CLI test: Add 1 sub-exercise, verify list shows
- [ ] Manual CLI test: Add 2+ sub-exercises, verify all display
- [ ] Manual CLI test: Change block type, verify prefix color changes

**Commit Message**:
```
feat(cli): improve compound block display formatting

- Show placeholder for empty compound blocks
- Add colored type prefixes ([EMOM], [AMRAP], [CIRCUIT], [INTERVAL])
- Highlight empty blocks to indicate they need sub-exercises
- Support display at all stages (empty, partial, complete)
```

**Agent Invocations**:
```bash
# Implementation
shredly-code-writer agent with:
"Implement Phase 3 from ticket #007: Update cli/lib/workout-formatter.ts to handle empty
compound blocks with placeholders, add colored type prefixes, highlight empty blocks.
Use chalk for colors."

# Testing
test-writer agent with:
"Write unit tests for ticket #007 Phase 3 formatting. Test: empty blocks show placeholder,
type prefixes display correctly, colors applied, partial and complete blocks render."

# Review
test-critic agent with:
"Review formatting tests for ticket #007 Phase 3. Ensure coverage of all block states
(empty, partial, complete) and all block types (EMOM, AMRAP, Circuit, Interval)."
```

---

## Testing Strategy

### Unit Tests

- [ ] Test `createCompoundBlock()` creates valid exercise structure
- [ ] Test `setCompoundBlockType()` changes category and updates name
- [ ] Test `updateCompoundBlockName()` generates correct prefixes
- [ ] Test empty block has placeholder name
- [ ] Test name updates when sub-exercises added/removed
- [ ] Test undo stack for all compound block operations
- [ ] Test formatter handles empty compound blocks
- [ ] Test formatter applies correct type prefixes and colors

### Integration Tests

- [ ] End-to-end: Create empty EMOM block, add 2 sub-exercises, change to Circuit, save
- [ ] End-to-end: Create AMRAP block, add sub-exercise, delete block, undo, verify restored
- [ ] End-to-end: Create compound block, change type multiple times, verify name updates
- [ ] Validate generated workout JSON matches WORKOUT_SPEC.md for compound exercises

### Manual Testing

**CLI (Phase 1)**:
```bash
npm run cli
# Generate workout
# Press 'x' to edit
# Expected: Editor opens in view mode
```

**Creating Compound Block**:
1. Press 'b' at any insertion point
2. Verify: New EMOM block appears with placeholder name
3. Press 'e' to open exercise database
4. Select exercise (e.g., "Pull-ups")
5. Verify: Sub-exercise added, parent name updates to "[EMOM] EMOM: Pull-ups"
6. Press 'e' again, add "Push-ups"
7. Verify: Name updates to "[EMOM] EMOM: Pull-ups + Push-ups"

**Changing Block Type**:
1. Navigate to EMOM block (created above)
2. Press 'a' to change to AMRAP
3. Verify: Name changes to "[AMRAP] AMRAP: Pull-ups + Push-ups"
4. Press 'c' to change to Circuit
5. Verify: Name changes to "[CIRCUIT] CIRCUIT: Pull-ups + Push-ups"
6. Press 'i' to change to Interval
7. Verify: Name changes to "[INTERVAL] INTERVAL: Pull-ups + Push-ups"

**Undo/Redo**:
1. Press 'u' to undo last type change
2. Verify: Block reverts to Circuit
3. Press 'u' multiple times
4. Verify: Block eventually removed (all operations undone)

**Save and Reload**:
1. Create compound block with 2 sub-exercises
2. Press ':' then 'w' to save
3. Quit and reload file
4. Verify: Compound block persists with correct structure

### Test Acceptance Criteria

- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] TypeScript compilation succeeds (`npm run typecheck`)
- [ ] Build succeeds (`npm run build`)
- [ ] Manual testing checklist complete
- [ ] Compound blocks validate against WORKOUT_SPEC.md schema

---

## Success Criteria

- [ ] User can press 'b' to create empty compound exercise block
- [ ] User can add sub-exercises to compound block via exercise database
- [ ] User can press 'e', 'a', 'c', 'i' to change block type
- [ ] Parent block name auto-updates with correct type prefix when sub-exercises change
- [ ] Empty blocks show clear placeholder indicating action needed
- [ ] Block types display with distinct colored prefixes
- [ ] All operations are undoable via 'u' hotkey
- [ ] Created blocks match workout engine-generated block format
- [ ] Code follows CLAUDE.md standards
- [ ] Data structures comply with WORKOUT_SPEC.md
- [ ] TypeScript types are properly used
- [ ] Help overlay documents new hotkeys

---

## Dependencies

### Blocked By
- None

### Blocks
- None (independent feature enhancement)

### External Dependencies
- None (uses existing workout_generation_rules.json, exercise_database.json)

---

## Risks & Mitigations

### Risk 1: Confusing UX when block has no sub-exercises
- **Impact**: Medium
- **Probability**: Medium
- **Mitigation**: Clear placeholder text, status messages guide user to press 'e' to add sub-exercises, help overlay explains workflow

### Risk 2: Name generation conflicts with manual edits
- **Impact**: Low
- **Probability**: Low
- **Mitigation**: Only auto-update name when sub-exercises change (not on every edit), allow manual override via 'r' (replace) if user wants custom name

### Risk 3: Type changes might invalidate week parameters
- **Impact**: Medium
- **Probability**: Low
- **Mitigation**: When changing type, preserve compatible parameters (work_time stays for all types), warn user if parameters will be reset, add to undo stack so user can revert

### Risk 4: Compound blocks without sub-exercises break validation
- **Impact**: High
- **Probability**: Low
- **Mitigation**: Workout validator should allow empty sub_exercises array (it's valid during editing), only warn on save if empty (don't block save), consider auto-removing empty blocks on save (with confirmation)

---

## Notes

**Design Decisions**:
- Default to EMOM category when creating block (most common compound type)
- Auto-update name only when sub-exercises change, not on manual field edits (prevents overwriting custom names)
- Allow empty sub-exercises array during editing (validation warns but doesn't error)
- Use same keyboard shortcuts across all view modes for consistency

**Future Enhancements** (Not in this ticket):
- Auto-suggest sub-exercises based on parent block category (e.g., EMOM suggests bodyweight exercises)
- Duplicate sub-exercise functionality (copy existing sub-exercise structure)
- Reorder sub-exercises within compound block
- Convert standalone exercise to compound block (wrap in parent)
- Batch create compound blocks from template (e.g., "3-Round Circuit: Squats, Push-ups, Rows")

**Keyboard Shortcuts Summary**:
- `b` - Create compound block (defaults to EMOM)
- `e` - Set type to EMOM (or add sub-exercise if on empty block)
- `a` - Set type to AMRAP
- `c` - Set type to Circuit
- `i` - Set type to Interval
- `u` - Undo (works for all compound block operations)

**Integration with Existing Features**:
- Works with existing 'e' (exercise database browser) for adding sub-exercises
- Works with existing 'u' (undo) for reverting changes
- Works with existing 't' (tab navigation) to move between compound block fields
- Works with existing ':w' (save) to persist compound blocks
- Works with existing 'd'/'w' (day/week view) to view compound blocks in context

---

## Commit Standards Reminder

**MANDATORY**: Follow CLAUDE.md commit message standards:
- Format: `type(scope): description under 50 chars`
- Types: feat, fix, docs, style, refactor, test, chore
- Scopes: cli, engine, questionnaire, profile, schedule, live, workout-gen, exercise-selector, progression, ui, mobile, history, prs, tests
- **NEVER include "Generated with [Claude Code]" or "Co-Authored-By: Claude"**

---

## Definition of Done

- [ ] All phases implemented and tested
- [ ] All tests passing
- [ ] TypeScript compilation succeeds
- [ ] Code reviewed (by code-quality-assessor agent)
- [ ] Success criteria met
- [ ] Documentation updated (cli_hotkeys.json, help overlay)
- [ ] Committed with proper commit messages
- [ ] CLAUDE.md "Current Development Status" updated
- [ ] Manual testing confirms workflow is intuitive
- [ ] Compound blocks validate against WORKOUT_SPEC.md
